/**
\page masterclass-22-12 PLUMED Masterclass 22.12: Free energy calculations for crystalline solids with the environment similarity CV 

\authors Pablo Piaggi
\date July 18, 2022

\section masterclass-22-12-aims Aims

This Masterclass is an introduction to the use of the environment similarity CV available in PLUMED to the calculation of liquid-solid free energy differences (chemical potentials).

\section masterclass-22-12-lo Objectives

The objectives of this Masterclass are:
- Learn to define reference environments for a crystal structure and choose appropriate parameters
- Learn how to run simulations in which the bulk liquid and the bulk solid are reversibly interconverted
- Learn how to run biased coexistence simulations (similar to interface pinning)
- Understand the importance of finite size effects in these simulations
- Understand the advantages and limitations of each method

\section masterclass-22-12-prereq Prerequisites

We assume that the person that will follow this tutorial is familiar with the linux terminal, LAMMPS, and basic functionality of PLUMED.
Knowledge of one enhanced sampling technique, such as metadynamics, is recommended.
Familiarity with at least one plotting software is required, for instance, gnuplot, xmgrace, or python with matplotlib.

\section masterclass-22-12-install Setting up PLUMED

We will use LAMMPS and PLUMED to perform the calculations.
Conda packages with the software required for this class have been prepared and you can install them following the instructions in [this link](https://github.com/plumed/masterclass-2022).
Make sure to install the conda package for LAMMPS.

The environment similarity CV is a part of the crystallization module and you will need to enable this module if you are compiling PLUMED on your own.
Also, LAMMPS has to be compiled with the following optional packages PLUMED, MANYBODY, EXTRA-DUMP, and EXTRA-FIX.

The data needed to run the exercises of this Masterclass can be found on [GitHub](https://github.com/PabloPiaggi/masterclass-22-12).
You can clone this repository locally on your machine using the following command:

\verbatim
git clone https://github.com/PabloPiaggi/masterclass-22-12
\endverbatim

\section masterclass-22-12-theory Summary of theory

We would like to define a per-atom quantity that tells us how similar the environments around atoms in the simulation box are to the environments found in some reference crystal structure.
Crystal structures are usually defined by a Bravais lattice with an associated basis of atoms.
An important consideration, that follows from the symmetry properties of lattices, is that the number of distint environments that exist in a crystal structure is equal to the number of atoms in the basis \f$M\f$.
To judge if a given environment is compatible with a given crystal structures, we will have to compare it against \f$M\f$ reference environments.

The environment similarity kernel is a way to quantify the similarity between environments.
This idea was introduced in this article \cite Piaggi-JCP-2019 and is based on the [SOAP descriptors](https://journals.aps.org/prb/abstract/10.1103/PhysRevB.87.184115) of Bartok et al.
Unlike SOAPs, this kernel will be non rotationally invariant and thus will break the SO(3) symmetry of space.
The starting point for the definition of our CV is the local atomic density around a given atom.
We consider an environment \f$\chi\f$ around this atom and we define the density by,
\f[
 \rho_{\chi}(\mathbf{r})=\sum\limits_{i\in\chi} \exp\left(- \frac{|\mathbf{r}_i-\mathbf{r}|^2} {2\sigma^2} \right),
\f]
where \f$i\f$ runs over the neighbors in the environment \f$\chi\f$, \f$\sigma\f$ is a broadening parameter, and \f$\mathbf{r}_i\f$ are the
coordinates of the neighbors relative to the central atom.
We will see later how the best \f$\sigma\f$ can be rigorously determined.
We now define a single reference environment \f$\chi_0\f$ that contains \f$n\f$ reference positions \f$\{\mathbf{r}^0_1,...,\mathbf{r}^0_n\}\f$
that describe, for instance, the nearest neighbors in a given crystal structure.

The environments \f$\chi\f$ and \f$\chi_0\f$ are compared using the kernel,
\f[
 k_{\chi_0}(\chi)= \int d\mathbf{r} \rho_{\chi}(\mathbf{r}) \rho_{\chi_0}(\mathbf{r}) .
\f]
Combining the two equations above and performing the integration analytically we obtain,
\f[
 k_{\chi_0}(\chi)= \sum\limits_{i\in\chi} \sum\limits_{j\in\chi_0} \pi^{3/2} \sigma^3  \exp\left(- \frac{|\mathbf{r}_i-\mathbf{r}^0_j|^2} {4\sigma^2} \right).
\f]
The kernel is finally normalized,
\f[
 \tilde{k}_{\chi_0}(\chi)  = \frac{1}{n} \sum\limits_{i\in\chi} \sum\limits_{j\in\chi_0} \exp\left( - \frac{|\mathbf{r}_i-\mathbf{r}^0_j|^2} {4\sigma^2} \right),
\f]
such that \f$\tilde{k}_{\chi_0}(\chi_0) = 1\f$.
We note that using the normalization above, the measure looses the symmetry property \f$ k_{\chi_0}(\chi) = k_{\chi}(\chi_0)  \f$.

The definition above is only useful for Bravais lattices since these have a single, unique atomic environment.
The kernel can be generalized to crystal structures described as a lattice with a basis of more than one atom.
As discussed above, in this case there is more than one type of environment.
We consider the case of \f$M\f$ environments \f$X = \chi_1,\chi_2,...,\chi_M\f$ and we define the kernel through a best match strategy:
\f[
 \tilde{k}_X(\chi)= \frac{1}{\lambda} \log \left ( \sum\limits_{l=1}^{M}\exp \left (\lambda \: \tilde{k}_{\chi_l}(\chi) \right ) \right ).
\f]
For a large enough \f$\lambda\f$ this expression will select the largest \f$\tilde{k}_{\chi_l}(\chi)\f$ with \f$\chi_l \in X\f$.

\f$ \tilde{k}_X(\chi) \f$ is a per-atom quantity and we will have to compute global functions of these quantities, for instance, the mean or the number of atoms with at \f$ \tilde{k}_X(\chi) \f$ larger than some value.

\section masterclass-22-12-system The system: Sodium as the alanine dipeptide of solids

Alanine dipeptide is the prototypical system on which enhanced sampling methods are tested (and sometimes benchmarked) on.
The reasons behind this choice is that alanine dipeptide is a small and relatively simple molecule that nonetheless captures well the phenomenon of conformational isomerism with relatively large free energy barriers.
I argue that a similar system in the context of materials is sodium.
It crystallizes in the bcc structure which is one of the simplest crystal structures.
Also, it does not show the competition between fcc and hcp structures typical of systems that crystallize in these two compact structures.
This fact greatly simplifies the task of characterizing the structure: all that we can see is liquid or bcc environments.
We will use an embedded atom model (EAM) for sodium.

\section masterclass-22-12-ex-1 Exercise 1: Choosing reference environments and apropriate \f$\sigma\f$ values

In the case of the bcc structure, the reference environment for the environment similarity CV can be chosen automatically using the following PLUMED input:

\plumedfile
ENVIRONMENTSIMILARITY ...
 SPECIES=1-1024
 CRYSTAL_STRUCTURE=BCC
 LATTICE_CONSTANTS=0.423
 SIGMA=0.07
... ENVIRONMENTSIMILARITY

\endplumedfile

Here we have chosen the bcc crystal structure with a lattice constant of 0.423 nm which is appropriate for bcc sodium.
This choice will automatically build an environment with 14 nearest neighbors.
There are other structures for which environments can be built automatically, see the manual for further information \ref ENVIRONMENTSIMILARITY .
Another option is to use CRYSTAL_STRUCTURE=CUSTOM and provide environments manually as PDB files using the REFERENCE keyword.
In this case, I suggest using the [Environment Finder](https://mybinder.org/v2/gh/PabloPiaggi/EnvironmentFinder/master?urlpath=apps%2FApp.ipynb) app to determine the appropriate environments for your structure.

For the PLUMED input above we also have to determine the value for the SIGMA keyword.
The first exercise of this class is to determine this value.
Here is the rationale behind the choice.
We are trying to determine a per-atom quantity that is able to distinguish liquid from solid environments.
We should find a SIGMA such that the probability of mislabeling liquid atoms as solid, and viceversa, is minimized.
This can be done by computing the probability of finding a given value of \f$ \tilde{k}_X(\chi) \f$ in the bulk solid and the bulk liquid.
So, first things first, let's do a simulation of the bulk liquid and the bulk bcc solid!

cd to the folder 1-distributions/bcc and run the command:
\verbatim
mpiexec lmp -in start.lmp > /dev/null &
\endverbatim
Then cd to the folder 1-distributions/liquid and run again the same command.
These commands will run simulations of the bulk liquid and bulk solid at 1 bar and 375 K.
I have chosen this temperature because it is close to coexistence for these phases.
The files start.lmp are the LAMMPS input and they specify that we are doing a NPT simulations.
The output of these runs are in the files log.lammps, dump.na, and out.dcd .
log.lammps is a log file that also contains some thermodynamic ouput.
dump.na is the trajectory is LAMMPS dump atom format and it is useful for visualization with [Ovito](https://www.ovito.org/).
out.dcd is the trajectory in DCD format, which is useful to postprocess directly using PLUMED's driver, as we shall see.

Once that these simulations have completed, we will compute the distributions of the environment similarity kernel using this input

\plumedfile
ENVIRONMENTSIMILARITY ...
 SPECIES=1-1024
 SIGMA=replace
 CRYSTAL_STRUCTURE=BCC
 LATTICE_CONSTANTS=0.423
 LABEL=s
 MEAN
... ENVIRONMENTSIMILARITY

hh: HISTOGRAM ...
   DATA=s
   GRID_MIN=-0.5
   GRID_MAX=2
   GRID_BIN=1000
   BANDWIDTH=0.01
...

DUMPGRID GRID=hh FILE=histo
\endplumedfile 

Here, SIGMA=replace has to be replaced by an apprpriate value. 
The action HISTOGRAM will compute the normalized histogram using all per-atom values of the kernel and the action DUMPGRID will write it to a file named histo.
We have to compute these histograms for different values of SIGMA and this can be done with the script run.sh in the folder 1-distributions (execute the command ./run.sh > results.txt).
This script will calculate the distributions and their overlaps for different SIGMA.
The overlap \f$O(p,q)\f$ between two distributions \f$p(x)\f$ and \f$q(x)\f$ can be defined in a variety of ways. Here we use,
\f[
O(p,q) = \int dx \: min[p(x),q(x)]
\f]

The output of the script will have two columns, the sigma value used and the overlap between the liquid and solid distributions of the kernel for that sigma.
Plot sigma vs overlap.
The best choice of SIGMA will be the one that minimizes the overlap which in this case should be around 0.07 nm.
Did you get that result? Great! Then, let's move to the next task.

Now let's plot the distributions of the kernel in the liquid and in the solid.
Plot simultaneously the histograms in ```1-distributions/liquid/histo-0.07``` and ```1-distributions/bcc/histo-0.07``` (column 1 vs column 2).
How do the distributions look like? Do they have overlap? 
Determine 1) the maximum for each distribution, and 2) the kernel value for which both distributions have equal values.
We will need these values for the next exercise!

\section masterclass-22-12-ex-2 Exercise 2: Bulk interconversion

We now move to the first method to calculate chemical potentials, the bulk interconversion method.
This method is based on simulating the reversible interconversion of the liquid to the solid and calculating the difference in chemical potential using:
\f[
\Delta\mu = -\frac{1}{\beta N} \ln \left ( Z_\beta / Z_\alpha \right)
\f]
with \f$Z_\alpha\f$ and \f$Z_\beta\f$ the partition functions restricted to each phase.
These are computed with the formulae,
\f[
Z_\alpha = \int\limits_{-\infty}^{s^*} ds \int d\mathbf{R} e^{-\beta [U(\mathbf{R},V)+PV]} \delta (s-s(\mathbf{R},V))
\f]
\f[
Z_\beta = \int\limits_{s^*}^{\infty} ds \int d\mathbf{R} e^{-\beta [U(\mathbf{R},V)+PV]} \delta (s-s(\mathbf{R},V))
\f]
assuming that the collective variable \f$ s \f$ can separate well the phases at threshold \f$ s^* \f$ .
The ratio of the partition functions is easy to calculate if we have a simulation in which both phases are visited, as we shall see below.

In a standard MD simulation we would only observe a single phase, and in order to see interconversion we need to apploy a bias potential.
Here we will use \ref OPES to construct a bias potential (see the corresponding Masterclass \ref ) as a function of the environment similarity kernels.
If you prefer to use \ref METAD or \ref VES , you can do so, adapting the input accordingly.
Otherwise, you may want to have a look at the \ref masterclass-22-03.

The environment similarity kernel, which are per-atom quantities, can be combined into a global quantity by evaluating how many have a value larger than some threshold.
In file ```2-bulk-interconversion/250atoms/400K/plumed.dat``` we can see the input for a simulation with 250 atoms at 400 K,
\plumedfile
ENVIRONMENTSIMILARITY ...
 SPECIES=1-250
 SIGMA=0.07
 CRYSTAL_STRUCTURE=BCC
 LATTICE_CONSTANTS=0.423
 LABEL=cv
 MORE_THAN={CUBIC D_0=0.38 D_MAX=0.80}
 MEAN
... ENVIRONMENTSIMILARITY
\endplumedfile
Here you see that we are calculating the MEAN and the number of atoms that have a value of the kernel MORE_THAN something.
Here, instead of having a strict threshold at some value we have a continuous and differentiable switching function that is 0 below 0.38, 1 above 0.80 and changes smoothly in between these values.
The values for D_0 and D_MAX have been chosen based on the maxima of the distributions determined in the previous exercise. Did you get that right? I hope you did.

The input for OPES is very simple,
\plumedfile
opes: OPES_METAD ARG=cv.morethan PACE=500 BARRIER=100 TEMP=400 STRIDE=2
\endplumedfile
and uses the morethan value described above as CV.
We estimate a barrier of less than 100 kJ/mol and that's the rationale behind the choice of BARRIER.
If you are using well tempered METAD you might want to use a biasfactor of around 40.
The other keywords are fairly standard.

We will also use a trick to avoid forming structures that have orientations different from the one that we are trying to form.
This will discuss during the lecture and the PLUMED input is:
```
q6: Q6 SPECIES=1-250 SWITCH={CUBIC D_0=0.4 D_MAX=0.5} VMEAN
diff: MATHEVAL ARG=q6.vmean,cv.mean FUNC=(x-0.0604)/(0.397-0.0604)-(y-0.387)/(0.756-0.387) PERIODIC=NO
UPPER_WALLS ARG=diff AT=0.1 KAPPA=100000 EXP=2 LABEL=uwall STRIDE=2
```
In a nutshell we are limiting the increase of Q6 (rotationally invariant) not followed by an increase in ENVIRONMENTSIMILARITY (non rotationally invariant).

The tasks for this exercise are to run a few simulations at different temperatures (say, 380 K, 400 K, 420K, or more if you have a computer cluster available).
10 or 20 ns should suffice, but you may run them for longer if you are using a computer cluster.



\section masterclass-22-12-ex-3 Exercise 3: Biased coexistence (interface pinning)

\section masterclass-22-12-ex-4 Exercise 4: Thermodynamic integration along isobars

\section masterclass-22-12-ex-4 Exercise 5 (optional): Custom environments


*/

link: @subpage masterclass-22-12

description: This Masterclass explains how to perform free energy calculations for crystalline solids with the environment similarity CV
