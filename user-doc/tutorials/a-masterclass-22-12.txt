/**
\page masterclass-22-12 PLUMED Masterclass 22.12: Free energy calculations for crystalline solids with the environment similarity CV 

\authors Pablo Piaggi
\date July 18, 2022

\section masterclass-22-12-aims Aims

This Masterclass is an introduction to the use of the environment similarity CV available in PLUMED to the calculation of liquid-solid free energy differences (chemical potentials).

\section masterclass-22-12-lo Objectives

The objectives of this Masterclass are:
- Learn to define reference environments for a crystal structure and choose appropriate parameters
- Learn how to run simulations in which the bulk liquid and the bulk solid are reversibly interconverted
- Learn how to run biased coexistence simulations (similar to interface pinning)
- Understand the importance of finite size effects in these simulations
- Understand the advantages and limitations of each method

\section masterclass-22-12-install Setting up PLUMED

We will use LAMMPS and PLUMED to perform the calculations.
Conda packages with the software required for this class have been prepared and you can install them following the instructions in [this link](https://github.com/plumed/masterclass-2022).
Make sure to install the conda package for LAMMPS.

The environment similarity CV is a part of the crystallization module and you will need to enable this module if you are compiling PLUMED on your own.
Also, LAMMPS has to be compiled with the following optional packages PLUMED, MANYBODY, EXTRA-DUMP, and EXTRA-FIX

The data needed to run the exercises of this Masterclass can be found on [GitHub](https://github.com/PabloPiaggi/masterclass-22-12).
You can clone this repository locally on your machine using the following command:

\verbatim
git clone https://github.com/PabloPiaggi/masterclass-22-12
\endverbatim

\section masterclass-22-12-theory Summary of theory

We would like to define a per-atom quantity that tells us how similar the environments around atoms in the simulation box are to the environments found in some reference crystal structure.
Crystal structures are usually defined by a Bravais lattice with an associated basis of atoms.
An important consideration, that follows from the symmetry properties of lattices, is that the number of distint environments that exist in a crystal structure is equal to the number of atoms in the basis \f$M\f$.
To judge if a given environment is compatible with a given crystal structures, we will have to compare it against \f$M\f$ reference environments.

The environment similarity kernel is a way to quantify the similarity between environments.
This idea was introduced in this article \cite Piaggi-JCP-2019 and is based on the [SOAP descriptors](https://journals.aps.org/prb/abstract/10.1103/PhysRevB.87.184115) of Bartok et al.
Unlike SOAPs, this kernel will be non rotationally invariant and thus will break the SO(3) symmetry of space.
The starting point for the definition of our CV is the local atomic density around a given atom.
We consider an environment \f$\chi\f$ around this atom and we define the density by,
\f[
 \rho_{\chi}(\mathbf{r})=\sum\limits_{i\in\chi} \exp\left(- \frac{|\mathbf{r}_i-\mathbf{r}|^2} {2\sigma^2} \right),
\f]
where \f$i\f$ runs over the neighbors in the environment \f$\chi\f$, \f$\sigma\f$ is a broadening parameter, and \f$\mathbf{r}_i\f$ are the
coordinates of the neighbors relative to the central atom.
We will see later how the best \f$\sigma\f$ can be rigorously determined.
We now define a single reference environment \f$\chi_0\f$ that contains \f$n\f$ reference positions \f$\{\mathbf{r}^0_1,...,\mathbf{r}^0_n\}\f$
that describe, for instance, the nearest neighbors in a given crystal structure.

The environments \f$\chi\f$ and \f$\chi_0\f$ are compared using the kernel,
\f[
 k_{\chi_0}(\chi)= \int d\mathbf{r} \rho_{\chi}(\mathbf{r}) \rho_{\chi_0}(\mathbf{r}) .
\f]
Combining the two equations above and performing the integration analytically we obtain,
\f[
 k_{\chi_0}(\chi)= \sum\limits_{i\in\chi} \sum\limits_{j\in\chi_0} \pi^{3/2} \sigma^3  \exp\left(- \frac{|\mathbf{r}_i-\mathbf{r}^0_j|^2} {4\sigma^2} \right).
\f]
The kernel is finally normalized,
\f[
 \tilde{k}_{\chi_0}(\chi)  = \frac{1}{n} \sum\limits_{i\in\chi} \sum\limits_{j\in\chi_0} \exp\left( - \frac{|\mathbf{r}_i-\mathbf{r}^0_j|^2} {4\sigma^2} \right),
\f]
such that \f$\tilde{k}_{\chi_0}(\chi_0) = 1\f$.
We note that using the normalization above, the measure looses the symmetry property \f$ k_{\chi_0}(\chi) = k_{\chi}(\chi_0)  \f$.

The definition above is only useful for Bravais lattices since these have a single, unique atomic environment.
The kernel can be generalized to crystal structures described as a lattice with a basis of more than one atom.
As discussed above, in this case there is more than one type of environment.
We consider the case of \f$M\f$ environments \f$X = \chi_1,\chi_2,...,\chi_M\f$ and we define the kernel through a best match strategy:
\f[
 \tilde{k}_X(\chi)= \frac{1}{\lambda} \log \left ( \sum\limits_{l=1}^{M}\exp \left (\lambda \: \tilde{k}_{\chi_l}(\chi) \right ) \right ).
\f]
For a large enough \f$\lambda\f$ this expression will select the largest \f$\tilde{k}_{\chi_l}(\chi)\f$ with \f$\chi_l \in X\f$.

\section masterclass-22-12-system The system: Sodium as the alanine dipeptide of solids

Alanine dipeptide is the prototypical system on which enhanced sampling methods are tested (and sometimes benchmarked) on.
The reasons behind this choice is that alanine dipeptide is a small and relatively simple molecule that nonetheless captures well the phenomenon of conformational isomerism with relatively large free energy barriers.
I argue that a similar system in the context of materials is sodium.
It crystallizes in the bcc structure and it therefore does not show the competition between fcc and hcp structures typical of systems that crystallize in these two compact structures.
This fact greatly simplifies the task of characterizing the structure: all that we can see is liquid or bcc environments.
We will use an embedded atom model (EAM) for sodium.

\section masterclass-22-12-ex-1 Exercise 1: Choosing reference environments and apropriate \f$\sigma\f$ values

\section masterclass-22-12-ex-1 Exercise 1: Choosing reference environments and apropriate \f$\sigma\f$ values


*/

link: @subpage masterclass-22-12

description: This Masterclass explains how to perform free energy calculations for crystalline solids with the environment similarity CV
